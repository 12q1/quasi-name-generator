<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Name Kitchen - Cook Up the Perfect Name</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Generate unique and brandable names with advanced controls. Perfect for startups, projects, and creative endeavors.">
  <meta name="keywords" content="name generator, brand name generator, startup name, project name, fantasy name">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y6TKZCJ6SX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-Y6TKZCJ6SX');
  </script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

  <style>
    /* Base styles */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7fafc;
      /* gray-100 */
    }

    /* noUiSlider Styling */
    .noUi-target {
      background: #E5E7EB;
      border-radius: 9999px;
      border: none;
      box-shadow: none;
      height: 8px;
    }

    .noUi-connect {
      background: #F78212;
      border-radius: 9999px;
    }

    .noUi-connects {
      border-radius: 9999px;
    }

    .noUi-handle {
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      background: #F78212;
      cursor: pointer;
      height: 24px !important;
      width: 24px !important;
      top: -8px !important;
      right: -12px !important;
    }

    .noUi-handle:focus {
      outline: none;
    }

    .noUi-handle::after,
    .noUi-handle::before {
      display: none;
    }

    .noUi-pips-horizontal {
      font-size: 10px;
      color: #718096;
    }

    /* Accordion Styling */
    details>summary {
      list-style: none;
    }

    details>summary::-webkit-details-marker {
      display: none;
    }

    details .summary-arrow {
      transition: transform 0.2s ease-in-out;
    }

    details[open] .summary-arrow {
      transform: rotate(90deg);
    }

    /* Custom Checkbox Styling */
    .custom-checkbox {
      appearance: none;
      -webkit-appearance: none;
      height: 1.25rem;
      width: 1.25rem;
      background-color: #e5e7eb;
      border-radius: 0.25rem;
      display: inline-block;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .custom-checkbox:checked {
      background-color: rgb(107 114 128 / var(--tw-text-opacity, 1));
    }

    .custom-checkbox:checked::after {
      content: '';
      position: absolute;
      left: 0.45rem;
      top: 0.2rem;
      width: 0.3rem;
      height: 0.6rem;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    /* Tooltip Styling */
    .tooltip-container {
      position: relative;
      display: inline-block;
    }

    .tooltip {
      visibility: hidden;
      width: 220px;
      background-color: #1f2937;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 10;
      bottom: 125%;
      left: 50%;
      margin-left: -110px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
      line-height: 1.4;
    }

    .tooltip-container:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }

    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1f2937 transparent transparent transparent;
    }

    /* Animation for copied message */
    .copied-toast {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .copied-toast.show {
      visibility: visible;
      opacity: 1;
    }

    .header {
      width: 100%;
      height: 15vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>

<body class="antialiased bg-amber-50">
  <div class="text-center">
    <div class="header">
      <img class="fit-picture max-h-full" src="./name_kitchen_logo_small_512x256.png" alt="Name Kitchen Logo" />
    </div>
  </div>

  <div class="min-h-screen container mx-auto p-4 lg:p-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <div class="lg:col-span-2 space-y-8">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-300/50">
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Name Length: <span id="lengthValue"
                  class="font-semibold text-gray-800">3 - 6</span></label>
              <div id="lengthSlider" class="mt-4"></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div>
                <label for="tone" class="block text-sm font-medium text-gray-700">Name Style
                  <div class="tooltip-container ml-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block text-gray-400" fill="none"
                      viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="tooltip">Brandable: Catchy, modern (e.g., 'Zylio'). Soft: Uses 'l, m, n'. Hard: Uses
                      'k, g, t'. Fantasy: Mythical sounding.</span>
                  </div>
                </label>
                <select id="tone"
                  class="mt-1 block w-full pl-3 py-2 text-base border border-gray-300/50 bg-gray-50 focus:outline-none focus:ring-gray-500 focus:border-gray-500 sm:text-sm rounded-md">
                  <option value="neutral">Neutral</option>
                  <option value="brand">Brandable</option>
                  <option value="soft">Soft</option>
                  <option value="hard">Hard</option>
                  <option value="fantasy">Fantasy</option>
                </select>
              </div>
              <div>
                <label for="startWith" class="block text-sm font-medium text-gray-700">Starts With</label>
                <select id="startWith"
                  class="mt-1 block w-full pl-3 py-2 text-base border border-gray-300/50 bg-gray-50 focus:outline-none focus:ring-gray-500 focus:border-gray-500 sm:text-sm rounded-md">
                  <option value="any">Any</option>
                  <option value="vowel">Vowel</option>
                  <option value="consonant">Consonant</option>
                </select>
              </div>
            </div>
            <details id="advanced-options" class="bg-gray-50 p-4 rounded-lg border border-gray-300/50">
              <summary class="flex justify-between items-center cursor-pointer font-medium text-gray-800">
                <span class="flex items-center">
                  Advanced Controls
                  <div class="tooltip-container ml-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                      <span class="tooltip">Fine-tune the name generation engine. Adjust probabilities, add required text, and disable specific letters or sounds (phonemes).</span>
                  </div>
                </span>
                <svg class="summary-arrow w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
              </summary>
              <div class="mt-4 border-t border-gray-200 pt-4 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                  <div>
                    <label for="must-start-with" class="block text-sm font-medium text-gray-700">Required Prefix</label>
                    <input type="text" id="must-start-with" placeholder="e.g., Pro, Geo" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2">
                  </div>
                  <div>
                    <label for="must-end-with" class="block text-sm font-medium text-gray-700">Required Suffix</label>
                    <input type="text" id="must-end-with" placeholder="e.g., ly, ify" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2">
                  </div>
                   <div>
                    <label for="exclude" class="block text-sm font-medium text-gray-700">Exclude Letters/Clusters</label>
                    <input type="text" id="exclude" placeholder="e.g., x, zz, qu" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2">
                  </div>
                  <div>
                    <label for="numNamesInput" class="block text-sm font-medium text-gray-700">Number of Names</label>
                    <input type="number" id="numNamesInput" value="8" min="1" max="50" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2">
                  </div>
                </div>
                <div id="probability-sliders" class="space-y-6 pt-2">
                  <p class="text-sm text-gray-600">Use sliders to control the chance of different sound combinations appearing in the names.</p>
                </div>
                <div id="phoneme-toggles" class="space-y-4">
                  <p class="text-sm text-gray-600">Uncheck any specific sounds (phonemes) you want to exclude from generation.</p>
                </div>
                <div class="mt-6 pt-6 border-t border-gray-200 space-y-4">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" id="save-preset-name" placeholder="New Preset Name" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2">
                    <button id="save-preset-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                      Save Current Preset
                    </button>
                  </div>
                  <div>
                    <label for="presets-select" class="block text-sm font-medium text-gray-700">Load Settings Preset</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <select id="presets-select" class="block w-full pl-3 py-2 text-base border border-gray-300/50 bg-gray-50 focus:outline-none focus:ring-gray-500 focus:border-gray-500 sm:text-sm rounded-md">
                            <option value="default">Default</option>
                        </select>
                        <button id="delete-preset-btn" title="Delete Selected Preset" class="p-2 text-gray-400 hover:text-red-500 disabled:text-gray-300 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                  </div>
                  <button id="reset-advanced-btn"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    Reset Advanced Controls
                  </button>
                </div>
              </div>
            </details>
          </div>
          <div class="mt-8">
            <button id="generateBtn"
              class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-semibold text-white bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105">
              Generate Names
            </button>
          </div>
        </div>

        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-300/50">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Generated Names</h2>
            <div class="flex items-center space-x-3">
              <button id="export-generated-btn"
                class="text-sm font-medium text-gray-600 hover:text-gray-800 disabled:text-gray-400 disabled:cursor-not-allowed">Export</button>
            </div>
          </div>
          <div id="output" class="space-y-3">
            <p class="text-gray-500 text-center py-8">Click "Generate Names" to start!</p>
          </div>
          <div id="copied-toast"
            class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-4 rounded-lg shadow-xl copied-toast">Copied
            to clipboard!</div>
        </div>
      </div>

      <div class="lg:col-span-1 space-y-8">
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-300/50">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-500" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                  clip-rule="evenodd" />
              </svg>
              Favorites
            </h3>
            <div class="flex items-center space-x-3">
              <button id="export-favs-btn"
                class="text-sm font-medium text-gray-600 hover:text-gray-800 disabled:text-gray-400 disabled:cursor-not-allowed">Export</button>
              <button id="clear-favs-btn"
                class="text-sm font-medium text-gray-600 hover:text-red-600 disabled:text-gray-400 disabled:cursor-not-allowed">Clear</button>
            </div>
          </div>
          <div class="mb-4">
              <input type="search" id="favorites-search" placeholder="Search favorites..." class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2">
          </div>
          <div id="favorites-list" class="space-y-2 max-h-96 overflow-y-auto">
            <p class="text-gray-500 text-sm text-center">Your favorite names will appear here.</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-300/50">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gray-500" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z"
                  clip-rule="evenodd" />
              </svg>
              History
            </h3>
            <div class="flex items-center space-x-3">
              <button id="export-history-btn"
                class="text-sm font-medium text-gray-600 hover:text-gray-800 disabled:text-gray-400 disabled:cursor-not-allowed">Export</button>
              <button id="clear-history-btn"
                class="text-sm font-medium text-gray-600 hover:text-red-600 disabled:text-gray-400 disabled:cursor-not-allowed">Clear</button>
            </div>
          </div>
           <div class="mb-4">
               <input type="search" id="history-search" placeholder="Search history..." class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-500 focus:border-gray-500 sm:text-sm p-2">
           </div>
           <label class="flex items-center space-x-2 text-sm text-gray-600 mb-4 cursor-pointer">
              <input type="checkbox" id="history-persist-toggle" class="custom-checkbox">
              <span>Remember history across sessions</span>
           </label>
          <div id="history-list" class="space-y-2 max-h-96 overflow-y-auto">
            <p class="text-gray-500 text-sm text-center">Recently generated names will show up here.</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-300/50">
          <h3 class="font-bold text-lg mb-2">How it works</h3>
          <p class="text-sm text-gray-600">
            Name Kitchen uses phonetics and probability to blend vowels, consonants, and letter clusters into unique,
            pronounceable names. Adjust the settings to find the perfect fit for your project!
          </p>
        </div>
      </div>

    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // === STATE ===
      let isHistoryPersistenceEnabled = JSON.parse(localStorage.getItem('isHistoryPersistenceEnabled')) ?? true;
      let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      let history = (isHistoryPersistenceEnabled && JSON.parse(localStorage.getItem('nameHistory'))) || [];
      let presets = JSON.parse(localStorage.getItem('namePresets')) || {};

      const initialGenerationParams = {
        probVowelCluster: 0.2,
        probConsonantCluster: 0.25,
        probStartWithVowel: 0.3,
        probAddFinalCluster: 0.4,
      };
      let generationParams = { ...initialGenerationParams };
      const initialNamesToGenerate = 8;


      // === PHONEME POOLS & CONSTANTS ===
      const MAX_ATTEMPTS_PER_NAME = 100;
      const phonemes = {
        vowels: ["a", "e", "i", "o", "u"],
        vowelClusters: ["ae", "ai", "au", "ea", "ee", "ei", "eo", "eu", "ie", "io", "oa", "oe", "oo", "ou", "ua", "ue", "ui", "ia"],
        consonants: ["b", "c", "d", "f", "g", "h", "j", "k", "l", "m", "n", "p", "q", "r", "s", "t", "v", "w", "x", "y", "z"],
        consonantClusters: ["bl", "br", "ch", "cl", "cr", "dr", "fl", "fr", "gl", "gr", "kn", "ph", "pl", "pr", "qu", "sc", "scr", "sh", "shr", "sk", "sl", "sm", "sn", "sp", "spl", "spr", "st", "str", "sw", "th", "tr", "tw", "vr", "wh", "xr", "zh", "zr", "gn", "brn"],
        finalClusters: ["nd", "ng", "nt", "rk", "sh", "th", "ld", "rt", "st", "rd", "rm", "rn", "lp", "lt", "mp", "ft", "pt", "sk", "sp", "zz", "xx", "nch", "rch", "rth", "nth", "stle"]
      };
      const toneBias = {
        soft: ["l", "m", "n", "r", "s", "v"],
        hard: ["k", "g", "t", "d", "z", "x"],
        fantasy: ["ae", "qu", "dr", "el", "or", "ul", "th", "ar", "ion", "ys", "yx", "zar"],
        brand: ["ly", "zo", "ex", "iq", "sy", "io", "za", "ix", "fy"]
      };

      // === UI ELEMENT REFERENCES ===
      const lengthSliderEl = document.getElementById('lengthSlider');
      const lengthValue = document.getElementById('lengthValue');
      const generateBtn = document.getElementById('generateBtn');
      const outputEl = document.getElementById('output');
      const startWithSelect = document.getElementById('startWith');
      const phonemeTogglesContainer = document.getElementById('phoneme-toggles');
      const favoritesListEl = document.getElementById('favorites-list');
      const historyListEl = document.getElementById('history-list');
      const copiedToastEl = document.getElementById('copied-toast');
      const probabilitySlidersContainer = document.getElementById('probability-sliders');
      const numNamesInput = document.getElementById('numNamesInput');
      const excludeInput = document.getElementById('exclude');
      const mustStartWithInput = document.getElementById('must-start-with');
      const mustEndWithInput = document.getElementById('must-end-with');

      // Search Inputs
      const favoritesSearchInput = document.getElementById('favorites-search');
      const historySearchInput = document.getElementById('history-search');

      // History Persistence
      const historyPersistToggle = document.getElementById('history-persist-toggle');

      // Presets
      const presetsSelect = document.getElementById('presets-select');
      const savePresetBtn = document.getElementById('save-preset-btn');
      const savePresetNameInput = document.getElementById('save-preset-name');
      const deletePresetBtn = document.getElementById('delete-preset-btn');

      // Buttons
      const exportFavsBtn = document.getElementById('export-favs-btn');
      const clearFavsBtn = document.getElementById('clear-favs-btn');
      const exportGeneratedBtn = document.getElementById('export-generated-btn');
      const exportHistoryBtn = document.getElementById('export-history-btn');
      const clearHistoryBtn = document.getElementById('clear-history-btn');
      const resetAdvancedBtn = document.getElementById('reset-advanced-btn');

      // === UTILITY & CORE LOGIC ===
      const getRandomInt = (max) => Math.floor(Math.random() * max);
      const choose = (arr) => arr.length > 0 ? arr[getRandomInt(arr.length)] : '';
      
      const isVowel = (char) => phonemes.vowels.includes(char);

      const generateQuasiName = (options) => {
        const prefix = options.prefix.toLowerCase();
        const suffix = options.suffix.toLowerCase();
        const fixedLength = prefix.length + suffix.length;
        
        let minCoreLength = options.minLength - fixedLength;
        let maxCoreLength = options.maxLength - fixedLength;

        if (minCoreLength < 0) minCoreLength = 0;
        if (maxCoreLength < 0) return null; // Prefix/suffix too long

        for (let attempt = 0; attempt < MAX_ATTEMPTS_PER_NAME; attempt++) {
            let coreName = "";
            let currentIsVowel;

            if (prefix) {
                currentIsVowel = !isVowel(prefix.slice(-1));
            } else if (options.startWith === 'vowel') {
                currentIsVowel = true;
            } else if (options.startWith === 'consonant') {
                currentIsVowel = false;
            } else {
                currentIsVowel = Math.random() < options.params.probStartWithVowel;
            }
            
            while (coreName.length < maxCoreLength) {
                let phoneme;
                if (currentIsVowel) {
                    phoneme = Math.random() < options.params.probVowelCluster ? choose(options.filteredPhonemes.vowelClusters) : choose(options.filteredPhonemes.vowels);
                } else {
                    let pool = Math.random() < options.params.probConsonantCluster ? options.filteredPhonemes.consonantClusters : options.filteredPhonemes.consonants;
                    if (options.tone !== 'neutral' && toneBias[options.tone]) {
                        const biasPool = toneBias[options.tone].filter(p => !options.exclude.some(ex => p.includes(ex)));
                        pool = pool.concat(biasPool);
                    }
                    phoneme = choose(pool);
                }
                if (!phoneme || (coreName.length + phoneme.length) > maxCoreLength) break;
                coreName += phoneme;
                currentIsVowel = !currentIsVowel;
            }

            if (coreName.length < maxCoreLength && !suffix && Math.random() < options.params.probAddFinalCluster) {
                const finalCluster = choose(options.filteredPhonemes.finalClusters);
                if (finalCluster && (coreName.length + finalCluster.length <= maxCoreLength)) {
                    coreName += finalCluster;
                }
            }

            let finalName = prefix + coreName + suffix;
            finalName = finalName.replace(/(.)\1{2,}/g, '$1');

            if (finalName.length >= options.minLength && finalName.length <= options.maxLength) {
                return finalName.charAt(0).toUpperCase() + finalName.slice(1);
            }
        }
        return null; // Failed to generate a valid name
      };

      // === RENDER/UPDATE UI FUNCTIONS ===
      const renderList = (element, items, emptyMessage, filter, itemClass = '') => {
        element.innerHTML = '';
        const filteredItems = filter ? items.filter(item => item.toLowerCase().includes(filter.toLowerCase())) : items;
        
        if (filteredItems.length === 0) {
          element.innerHTML = `<p class="text-gray-500 text-sm text-center">${filter ? 'No matches found.' : emptyMessage}</p>`;
          return;
        }
        filteredItems.forEach(name => {
          const isFavorited = favorites.includes(name);
          const favIconPath = isFavorited ? "M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" : "M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z";
          const favIconClass = isFavorited ? 'text-red-500' : 'text-gray-400 hover:text-red-500';

          const itemHTML = `
                <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 ${itemClass}" data-name-container="${name}">
                    <span class="font-semibold text-lg text-gray-800" data-name-display="${name}">${name}</span>
                    <div class="flex items-center space-x-2">
                        <button class="edit-btn" data-name="${name}" title="Edit Name">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                        </button>
                         <button class="favorite-btn" data-name="${name}" title="Favorite">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-colors ${favIconClass}" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="${favIconPath}" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="copy-btn" data-name="${name}" title="Copy Name">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                    </div>
                </div>`;
          element.insertAdjacentHTML('beforeend', itemHTML);
        });
      };

      const updateName = (oldName, newName) => {
        if (!newName || oldName === newName) return;
        
        history = history.map(batch => batch.map(name => name === oldName ? newName : name));
        
        const favIndex = favorites.indexOf(oldName);
        if (favIndex > -1) {
          favorites[favIndex] = newName;
          localStorage.setItem('favorites', JSON.stringify(favorites));
        }
        updateAllLists();
        saveHistoryToLocalStorage();
      };
      
      const saveHistoryToLocalStorage = () => {
        if (isHistoryPersistenceEnabled) {
            localStorage.setItem('nameHistory', JSON.stringify(history));
        }
      };

      const updateAllLists = () => {
        const currentOutput = history.length > 0 ? history[0] : [];
        const favFilter = favoritesSearchInput.value;
        const historyFilter = historySearchInput.value;
        
        renderList(outputEl, currentOutput, 'Click "Generate Names" to start!');
        renderList(favoritesListEl, favorites, 'Your favorite names will appear here.', favFilter);
        renderList(historyListEl, history.flat(), 'Recently generated names will show up here.', historyFilter);

        const isHistoryEmpty = history.length === 0;
        const isFavoritesEmpty = favorites.length === 0;
        exportGeneratedBtn.disabled = currentOutput.length === 0;
        exportHistoryBtn.disabled = isHistoryEmpty;
        clearHistoryBtn.disabled = isHistoryEmpty;
        exportFavsBtn.disabled = isFavoritesEmpty;
        clearFavsBtn.disabled = isFavoritesEmpty;
      };

      // === EVENT HANDLERS ===
      const handleGenerateClick = () => {
        const manualExcludes = excludeInput.value.split(',').map(e => e.trim().toLowerCase()).filter(Boolean);
        const phonemeExcludes = Array.from(document.querySelectorAll('.phoneme-checkbox:not(:checked)')).map(cb => cb.dataset.phoneme);
        const allExcludes = [...new Set([...manualExcludes, ...phonemeExcludes])];

        const filteredPhonemes = Object.fromEntries(
          Object.entries(phonemes).map(([key, value]) => [
            key,
            value.filter(p => !allExcludes.some(ex => ex && p.includes(ex)))
          ])
        );

        const sliderValues = lengthSliderEl.noUiSlider.get();
        const namesToGenerate = parseInt(numNamesInput.value, 10) || initialNamesToGenerate;
        const options = {
          minLength: parseFloat(sliderValues[0]),
          maxLength: parseFloat(sliderValues[1]),
          tone: document.getElementById("tone").value,
          startWith: document.getElementById("startWith").value,
          exclude: allExcludes,
          filteredPhonemes: filteredPhonemes,
          params: generationParams,
          prefix: mustStartWithInput.value,
          suffix: mustEndWithInput.value,
        };

        outputEl.innerHTML = '<div class="flex justify-center items-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-600"></div><span class="ml-3 text-gray-500">Generating...</span></div>';
        setTimeout(() => {
          const newNames = new Set();
          let attempts = 0;
          while (newNames.size < namesToGenerate && attempts < (namesToGenerate * 50)) {
            const name = generateQuasiName(options);
            if (name) newNames.add(name);
            attempts++;
          }
          const nameArray = Array.from(newNames);
          history.unshift(nameArray);
          if (history.length > 20) history.pop(); // Keep history to last 20 generations
          updateAllLists();
          saveHistoryToLocalStorage();
        }, 50);
      };

      const handleListInteraction = (e) => {
        const button = e.target.closest('button');
        if (!button) return;

        const name = button.dataset.name;
        if (!name) return;

        if (button.classList.contains('copy-btn')) {
          navigator.clipboard.writeText(name).then(() => {
            copiedToastEl.classList.add('show');
            setTimeout(() => copiedToastEl.classList.remove('show'), 2000);
          }).catch(err => console.error('Failed to copy: ', err));
        } else if (button.classList.contains('favorite-btn')) {
          if (favorites.includes(name)) {
            favorites = favorites.filter(f => f !== name);
            gtag('event', 'nk_unfavorite', { 'send_to': 'G-Y6TKZCJ6SX', 'data': name });
          } else {
            favorites.unshift(name);
            gtag('event', 'nk_favorite', { 'send_to': 'G-Y6TKZCJ6SX', 'data': name });
          }
          localStorage.setItem('favorites', JSON.stringify(favorites));
          updateAllLists();
        } else if (button.classList.contains('edit-btn')) {
          const nameContainer = button.closest('[data-name-container]');
          const nameDisplay = nameContainer.querySelector('[data-name-display]');
          const input = document.createElement('input');
          input.type = 'text';
          input.value = name;
          input.className = 'font-semibold text-lg text-gray-800 bg-yellow-100 rounded px-1 w-full';

          nameDisplay.replaceWith(input);
          input.focus();
          input.select();

          const saveChanges = () => {
            const newName = input.value.trim();
            updateName(name, newName);
          };

          input.addEventListener('blur', saveChanges);
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') {
              updateAllLists(); 
            }
          });
        }
      };

      const exportToFile = (content, fileName, contentType) => {
        const a = document.createElement("a");
        const file = new Blob([content], { type: contentType });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
      };

      const handleResetAdvanced = () => {
        generationParams = { ...initialGenerationParams };
        Object.entries(probabilitySliders).forEach(([key, slider]) => {
          slider.noUiSlider.set(initialGenerationParams[key] * 100);
        });
        excludeInput.value = '';
        mustStartWithInput.value = '';
        mustEndWithInput.value = '';
        numNamesInput.value = initialNamesToGenerate;
        document.querySelectorAll('.phoneme-checkbox').forEach(cb => cb.checked = true);
        resetAdvancedBtn.textContent = 'Controls Reset!';
        setTimeout(() => { resetAdvancedBtn.textContent = 'Reset Advanced Controls'; }, 1500);
      };
      
      const getSettings = () => {
          const phonemeExcludes = Array.from(document.querySelectorAll('.phoneme-checkbox:not(:checked)')).map(cb => cb.dataset.phoneme);
          return {
              length: lengthSliderEl.noUiSlider.get(),
              tone: document.getElementById("tone").value,
              startWith: document.getElementById("startWith").value,
              exclude: excludeInput.value,
              prefix: mustStartWithInput.value,
              suffix: mustEndWithInput.value,
              numNames: numNamesInput.value,
              params: generationParams,
              phonemeExcludes: phonemeExcludes
          };
      };
      
      const applySettings = (settings) => {
          lengthSliderEl.noUiSlider.set(settings.length);
          document.getElementById("tone").value = settings.tone;
          document.getElementById("startWith").value = settings.startWith;
          excludeInput.value = settings.exclude;
          mustStartWithInput.value = settings.prefix;
          mustEndWithInput.value = settings.suffix;
          numNamesInput.value = settings.numNames;
          generationParams = settings.params;
          Object.entries(probabilitySliders).forEach(([key, slider]) => {
              if (settings.params[key] !== undefined) {
                  slider.noUiSlider.set(settings.params[key] * 100);
              }
          });
          document.querySelectorAll('.phoneme-checkbox').forEach(cb => {
              cb.checked = !settings.phonemeExcludes.includes(cb.dataset.phoneme);
          });
      };
      
      const populatePresetsDropdown = () => {
        presetsSelect.innerHTML = '<option value="default">Default</option>';
        Object.keys(presets).forEach(name => {
            presetsSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });
        deletePresetBtn.disabled = presetsSelect.value === 'default';
      };

      // === INITIALIZATION ===
      // 1. Length Slider
      const lengthSlider = noUiSlider.create(lengthSliderEl, { start: [3, 6], connect: true, range: { 'min': 2, 'max': 15 }, step: 1, tooltips: false, format: { to: v => Math.round(v), from: v => Number(v) } });
      lengthSlider.on('update', values => lengthValue.textContent = `${values[0]} - ${values[1]}`);

      // 2. 'Starts With' Dropdown
      // 'abcdefghijklmnopqrstuvwxyz'.split('').forEach(l => startWithSelect.innerHTML += `<option value="${l}">${l.toUpperCase()}</option>`);

      // 3. Probability Sliders
      const probabilitySliders = {};
      const probSliderConfig = {
        probVowelCluster: { label: 'Vowel Cluster Chance', start: initialGenerationParams.probVowelCluster * 100 },
        probConsonantCluster: { label: 'Consonant Cluster Chance', start: initialGenerationParams.probConsonantCluster * 100 },
        probStartWithVowel: { label: 'Starts with Vowel Chance', start: initialGenerationParams.probStartWithVowel * 100 },
        probAddFinalCluster: { label: 'Final Cluster Chance', start: initialGenerationParams.probAddFinalCluster * 100 }
      };

      Object.entries(probSliderConfig).forEach(([key, config]) => {
        const container = document.createElement('div');
        const label = document.createElement('label');
        label.className = "block text-sm font-medium text-gray-700 mb-2";
        const valueSpan = document.createElement('span');
        valueSpan.className = "font-semibold text-gray-800";
        label.innerHTML = `${config.label}: `;
        label.appendChild(valueSpan);

        const sliderEl = document.createElement('div');
        sliderEl.className = 'mt-1';

        container.appendChild(label);
        container.appendChild(sliderEl);
        probabilitySlidersContainer.appendChild(container);

        const slider = noUiSlider.create(sliderEl, {
          start: config.start, connect: 'lower', range: { 'min': 0, 'max': 100 }, step: 1, format: { to: v => Math.round(v), from: v => Number(v) }
        });

        slider.on('update', ([value]) => {
          const numValue = parseFloat(value);
          valueSpan.textContent = `${numValue}%`;
          generationParams[key] = numValue / 100;
        });
        probabilitySliders[key] = sliderEl;
      });

      // 4. Advanced Phoneme Toggles
      Object.keys(phonemes).forEach(key => {
        const title = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        const headerHTML = `<div class="flex justify-between items-center"><h5 class="font-semibold capitalize text-sm text-gray-600">${title}</h5><div class="flex space-x-2"><button data-group="${key}" data-action="select" class="text-xs font-medium text-gray-600 hover:text-gray-800">All</button><button data-group="${key}" data-action="deselect" class="text-xs font-medium text-gray-500 hover:text-gray-700">None</button></div></div>`;
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-2 mt-2';
        phonemes[key].forEach(p => {
          grid.innerHTML += `<label class="flex items-center space-x-2 text-sm"><input type="checkbox" class="custom-checkbox phoneme-checkbox border border-gray-300/50" checked data-phoneme="${p}" data-group="${key}"><span>${p}</span></label>`;
        });
        const groupContainer = document.createElement('div');
        groupContainer.className = 'border-t border-gray-200 pt-4';
        groupContainer.innerHTML = headerHTML;
        groupContainer.appendChild(grid);
        phonemeTogglesContainer.appendChild(groupContainer);
      });

      // 5. Set Initial State & Populate UI
      historyPersistToggle.checked = isHistoryPersistenceEnabled;
      populatePresetsDropdown();
      updateAllLists();

      // 6. Attach Event Listeners
      generateBtn.addEventListener("click", handleGenerateClick);
      document.body.addEventListener('click', handleListInteraction);
      resetAdvancedBtn.addEventListener('click', handleResetAdvanced);
      
      favoritesSearchInput.addEventListener('input', updateAllLists);
      historySearchInput.addEventListener('input', updateAllLists);

      historyPersistToggle.addEventListener('change', () => {
          isHistoryPersistenceEnabled = historyPersistToggle.checked;
          localStorage.setItem('isHistoryPersistenceEnabled', isHistoryPersistenceEnabled);
          if (isHistoryPersistenceEnabled) {
              saveHistoryToLocalStorage();
          } else {
              localStorage.removeItem('nameHistory');
          }
      });
      
      savePresetBtn.addEventListener('click', () => {
          const name = savePresetNameInput.value.trim();
          if (!name) {
              alert('Please enter a name for the preset.');
              return;
          }
          presets[name] = getSettings();
          localStorage.setItem('namePresets', JSON.stringify(presets));
          populatePresetsDropdown();
          presetsSelect.value = name;
          savePresetNameInput.value = '';
          deletePresetBtn.disabled = false;
      });
      
      deletePresetBtn.addEventListener('click', () => {
        const selectedPreset = presetsSelect.value;
        if (selectedPreset === 'default' || !presets[selectedPreset]) return;
        if (confirm(`Are you sure you want to delete the "${selectedPreset}" preset?`)) {
            delete presets[selectedPreset];
            localStorage.setItem('namePresets', JSON.stringify(presets));
            populatePresetsDropdown();
            deletePresetBtn.disabled = true;
        }
      });
      
      presetsSelect.addEventListener('change', () => {
          const selectedPreset = presetsSelect.value;
          deletePresetBtn.disabled = selectedPreset === 'default';
          if (selectedPreset === 'default') {
              // Create a default settings object to apply
              const defaultSettings = {
                length: [3, 6],
                tone: 'neutral',
                startWith: 'any',
                exclude: '',
                prefix: '',
                suffix: '',
                numNames: initialNamesToGenerate,
                params: initialGenerationParams,
                phonemeExcludes: []
              };
              applySettings(defaultSettings);
              handleResetAdvanced(); // Also visually reset sliders and buttons
          } else if (presets[selectedPreset]) {
              applySettings(presets[selectedPreset]);
          }
      });

      exportFavsBtn.addEventListener('click', () => {
        if (favorites.length > 0) exportToFile(favorites.join('\n'), 'name-kitchen-favorites.txt', 'text/plain');
      });
      exportGeneratedBtn.addEventListener('click', () => {
        const currentBatch = history.length > 0 ? history[0] : [];
        if (currentBatch.length > 0) exportToFile(currentBatch.join('\n'), 'name-kitchen-generated.txt', 'text/plain');
      });
      exportHistoryBtn.addEventListener('click', () => {
        if (history.length > 0) exportToFile(history.flat().join('\n'), 'name-kitchen-history.txt', 'text/plain');
      });

      clearHistoryBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear the entire generation history? This cannot be undone.')) {
          history = [];
          localStorage.removeItem('nameHistory');
          updateAllLists();
        }
      });
      clearFavsBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all favorites? This cannot be undone.')) {
          favorites = [];
          localStorage.setItem('favorites', JSON.stringify([]));
          updateAllLists();
        }
      });

      phonemeTogglesContainer.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.group) {
          const group = e.target.dataset.group;
          const action = e.target.dataset.action;
          const shouldBeChecked = action === 'select';
          document.querySelectorAll(`.phoneme-checkbox[data-group="${group}"]`).forEach(cb => cb.checked = shouldBeChecked);
        }
      });
    });
  </script>
</body>

</html>